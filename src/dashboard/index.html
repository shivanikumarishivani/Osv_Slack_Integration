<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Advanced OSV Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #eef1f5;
            margin: 0;
            padding: 20px;
            transition: 0.3s;
        }

        body.dark {
            background: #121212;
            color: white;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 32px;
        }

        .top-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        input,
        select {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #aaa;
        }

        .scan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            border-left: 5px solid #007bff;
        }

        body.dark .card {
            background: #1e1e1e;
            box-shadow: none;
            border-left: 5px solid #4dabf7;
        }

        .card:hover {
            transform: scale(1.02);
        }

        .change-box {
            background: #f5f7fa;
            padding: 12px;
            border-radius: 10px;
            margin-top: 12px;
            border: 1px solid #dce1e7;
        }

        body.dark .change-box {
            background: #2a2a2a;
            border: 1px solid #555;
        }

        .success {
            color: #059669;
            font-weight: bold;
        }

        .error {
            color: #dc2626;
            font-weight: bold;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 5px;
        }

        .added {
            background: #d1fae5;
            color: #065f46;
        }

        .updated {
            background: #fee2e2;
            color: #b91c1c;
        }

        .chart-container {
            max-width: 800px;
            margin: 30px auto;
            background: white;
            padding: 20px;
            border-radius: 15px;
        }

        body.dark .chart-container {
            background: #1e1e1e;
        }
    </style>
</head>

<body>

    <h1>üìä OSV Vulnerability Scan Dashboard</h1>

    <div class="top-controls">
        <input type="text" id="searchPackage" placeholder="Search package..." />
        <label>From: <input type="datetime-local" id="fromDate"></label>
        <label>To: <input type="datetime-local" id="toDate"></label>

        <select id="filterSeverity">
            <option value="all">All</option>
            <option value="vulnerable">Only Vulnerabilities</option>
        </select>

        <select id="sortBy">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="mostVulns">Most Vulnerabilities</option>
        </select>

        <button onclick="toggleDark()">üåô Toggle Dark Mode</button>
    </div>

    <div class="summary-grid">
        <div class="summary-card">
            <h2>Total Scans</h2>
            <p id="totalScans">0</p>
        </div>
        <div class="summary-card">
            <h2>Total Vulnerabilities</h2>
            <p id="totalVulns">0</p>
        </div>
        <div class="summary-card">
            <h2>Most Vulnerable Package</h2>
            <p id="topPackage">-</p>
        </div>
    </div>

    <style>
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: 0.2s;
        }

        body.dark .summary-card {
            background: #1e1e1e;
            box-shadow: none;
        }

        .summary-card:hover {
            transform: scale(1.03);
        }

        .summary-card h2 {
            margin: 0;
            font-size: 20px;
            color: #007bff;
        }

        body.dark .summary-card h2 {
            color: #4dabf7;
        }

        .summary-card p {
            font-size: 28px;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>


    <div id="scan-container" class="scan-grid"></div>

    <script>
        let scanData = [];

        async function loadData() {
            const res = await fetch("../../logs/scan_history.json");
            scanData = await res.json();
            renderDashboard();
            renderChart();
        }

        function renderDashboard() {
            let data = [...scanData];
            const container = document.getElementById("scan-container");
            container.innerHTML = "";

            const search = document.getElementById("searchPackage").value.toLowerCase();
            const from = document.getElementById("fromDate").value;
            const to = document.getElementById("toDate").value;
            const severity = document.getElementById("filterSeverity").value;
            const sort = document.getElementById("sortBy").value;

            data = data.filter(d => {
                if (from && new Date(d.timestamp) < new Date(from)) return false;
                if (to && new Date(d.timestamp) > new Date(to)) return false;
                if (severity === "vulnerable" && !d.changes.some(c => c.vulnsCount > 0)) return false;
                return true;
            });

            data.forEach(scan => scan.totalVulns = scan.changes.reduce((s, c) => s + c.vulnsCount, 0));

            if (sort === "newest") data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            if (sort === "oldest") data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            if (sort === "mostVulns") data.sort((a, b) => b.totalVulns - a.totalVulns);

            data.forEach(scan => {
                const card = document.createElement("div");
                card.classList.add("card");

                let changesHTML = scan.changes
                    .filter(c => c.name.toLowerCase().includes(search))
                    .map(c => `
        <div class="change-box">
          <span class="badge ${c.type}">${c.type.toUpperCase()}</span>
          <p><strong>${c.name}@${c.version}</strong> <br> Dependency: ${c.name}</p>
          <p>Vulnerabilities: ${c.vulnsCount}</p>
          ${c.remediation ? `<p class="success">Fix: ${c.remediation}</p>` : ""}
        </div>
      `).join("");

                card.innerHTML = `
      <div class="timestamp">‚è± ${scan.timestamp}</div>
      <p><strong>Total Dependencies:</strong> ${scan.totalDependencies}</p>
      <p><strong>Total Vulnerabilities:</strong> ${scan.totalVulns}</p>
      ${changesHTML}
    `;

                container.appendChild(card);
            });
        }

        document.querySelectorAll("#searchPackage, #fromDate, #toDate, #filterSeverity, #sortBy")
            .forEach(el => el.addEventListener("input", renderDashboard));

        function renderChart() {
            const ctx = document.getElementById("vulnChart");
            const labels = scanData.map(s => s.timestamp);
            const vulnCounts = scanData.map(s => s.changes.reduce((t, c) => t + c.vulnsCount, 0));

            new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{ label: "Vulnerabilities Over Time", data: vulnCounts }]
                }
            });
        }

        function toggleDark() { document.body.classList.toggle("dark"); }

        loadData();

        // Update Summary Cards
        function updateSummary() {
            document.getElementById("totalScans").textContent = scanData.length;

            const totalV = scanData.reduce((sum, s) => sum + s.changes.reduce((t, c) => t + c.vulnsCount, 0), 0);
            document.getElementById("totalVulns").textContent = totalV;

            let pkgMap = {};
            scanData.forEach(s => s.changes.forEach(c => {
                if (!pkgMap[c.name]) pkgMap[c.name] = 0;
                pkgMap[c.name] += c.vulnsCount;
            }));

            const top = Object.entries(pkgMap).sort((a, b) => b[1] - a[1])[0];
            document.getElementById("topPackage").textContent = top ? `${top[0]} (${top[1]})` : "-";
        }

        loadData().then(updateSummary);
    </script>
</body>

</html>